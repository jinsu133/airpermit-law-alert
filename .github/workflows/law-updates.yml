name: law-updates
on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
  push:
    branches:
      - main
concurrency:
  group: law-updates-hourly
  cancel-in-progress: true
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Validate Required Secrets
        env:
          LAW_OC: ${{ secrets.LAW_OC }}
          ASSEMBLY_KEY: ${{ secrets.ASSEMBLY_KEY }}
        run: |
          if [ -z "${LAW_OC}" ]; then
            echo "Missing secret: LAW_OC"
            exit 1
          fi
          if [ -z "${ASSEMBLY_KEY}" ]; then
            echo "Missing secret: ASSEMBLY_KEY"
            exit 1
          fi
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip list
      - name: Generate JSON (web)
        env:
          LAW_OC: ${{ secrets.LAW_OC }}
          ASSEMBLY_KEY: ${{ secrets.ASSEMBLY_KEY }}
          ASSEMBLY_AGE: ${{ secrets.ASSEMBLY_AGE }}
          CHANGELOG_START_DATE: "20210101"
        run: |
          python scripts/law_notifier.py --mode web --out public
          echo "--- Checking for health.json after script run ---"
          ls -l public/
      - name: Commit generated files + state
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/updates.json public/changes.json public/changelog.json public/health.json data/state.json data/history.json || true
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "Update law feed"
          for i in 1 2 3; do
            git pull --rebase origin main && git push origin main && break
            if [ "$i" -eq 3 ]; then
              echo "Failed to push after retries"
              exit 1
            fi
            sleep 5
          done
      - name: Wait for filesystem sync
        run: sleep 2
      - name: Delay check (fail if stale)
        env:
          OUT_DIR: public
          DELAY_THRESHOLD_MIN: "75"
        run: |
          python scripts/check_delay.py
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Send email alert on failure/stale
        if: failure()
        env:
          ALERT_SMTP_HOST: ${{ secrets.ALERT_SMTP_HOST }}
          ALERT_SMTP_PORT: ${{ secrets.ALERT_SMTP_PORT }}
          ALERT_SMTP_USER: ${{ secrets.ALERT_SMTP_USER }}
          ALERT_SMTP_PASS: ${{ secrets.ALERT_SMTP_PASS }}
          ALERT_TO: ${{ secrets.ALERT_TO }}
          ALERT_FROM: ${{ secrets.ALERT_FROM }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          WORKFLOW: ${{ github.workflow }}
          JOB: ${{ github.job }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
        run: |
          if [ -z "${ALERT_SMTP_HOST}" ] || [ -z "${ALERT_SMTP_USER}" ] || [ -z "${ALERT_SMTP_PASS}" ]; then
            echo "Skip alert: missing SMTP secrets"
            exit 0
          fi
          python - << 'PY'
          import os, smtplib
          from email.message import EmailMessage
          host=os.environ.get("ALERT_SMTP_HOST","")
          port = os.environ.get("ALERT_SMTP_PORT") or "587"
          user=os.environ.get("ALERT_SMTP_USER",""); pwd=os.environ.get("ALERT_SMTP_PASS","")
          to=(os.environ.get("ALERT_TO") or "help@airpermit.work").strip()
          frm=(os.environ.get("ALERT_FROM") or user or "").strip()
          try:
              port_int = int(str(port).strip() or "587")
          except ValueError:
              port_int = 587
          if not to or not frm:
              raise SystemExit("Missing recipient/from address")
          repo=os.environ.get("REPO",""); run_id=os.environ.get("RUN_ID","")
          workflow=os.environ.get("WORKFLOW",""); job=os.environ.get("JOB","")
          ref=os.environ.get("REF",""); sha=os.environ.get("SHA","")
          run_url=f"https://github.com/{repo}/actions/runs/{run_id}"
          msg=EmailMessage()
          msg["Subject"]=f"[airpermit.work 법령알림] 갱신 실패/지연 알림: {workflow}/{job}"
          msg["From"]=frm; msg["To"]=to
          msg.set_content(
              f"법령 알림 갱신 작업이 실패했거나 지연 임계치(75분)를 초과했습니다.\n\n"
              f"- Repo: {repo}\n- Workflow: {workflow}\n- Job: {job}\n- Ref: {ref}\n- SHA: {sha}\n- Run: {run_url}\n"
          )
          with smtplib.SMTP(host, port_int, timeout=30) as s:
              s.ehlo(); s.starttls(); s.login(user, pwd); s.send_message(msg)
          print("Alert email sent.")
          PY
